{"ts":1368444827188,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var http = require('http');\nvar https = require('https');\nvar zlib = require('zlib');\nvar ID = 'TempoDB: ';\n\nvar TempoDBClient = exports.TempoDBClient =\n    function(key, secret, options) {\n        /*\n            options\n                hostname (string)\n                port (Integer)\n                secure (Boolean)\n                version (string)\n        */\n        options = options || {};\n\n        const HOST = 'api.tempo-db.com',\n              PORT = 443,\n              VERSION = 'v1',\n              SECURE = true;\n\n        var hostname = options.hostname || HOST;\n        var auth = 'Basic ' + new Buffer(key+':'+secret).toString('base64');\n        var headers = {\n                'Host': hostname,\n                'Authorization': auth,\n                'User-Agent': \"tempodb-nodejs/0.2.1\",\n                'Accept-Encoding': 'gzip',\n                'Connection': 'keep-alive'\n        };\n\n        this.key = key;\n        this.secret = secret;\n        this.hostname = hostname;\n        this.port = options.port || PORT;\n        this.connection = options.secure || SECURE ? https : http;\n        this.version = options.version || VERSION;\n        this.path = '/' + this.version;\n        this.headers = headers;\n    }\n\nTempoDBClient.prototype.call = function(method, path, body, callback) {\n    var json_body = '';\n    if (body) {\n        json_body = JSON.stringify(body);\n        this.headers['Content-Length'] = json_body.length;\n    }\n    else {\n      this.headers['Content-Length'] = 0\n    }\n\n    var options = {\n        host: this.hostname,\n        port: this.port,\n        path: this.path+path || this.path,\n        method: method,\n        headers: this.headers\n    };\n\n    var req = this.connection.request(options, function (res) {\n        var data = '';\n        var response = res.statusCode;\n\n        if(res.headers['content-encoding'] == 'gzip') {\n          res = res.pipe(zlib.createGunzip());\n        }\n\n        //the listener that handles the response chunks\n        res.addListener('data', function (chunk) {\n            data += chunk.toString();\n        });\n\n        res.addListener('end', function() {\n            result = '';\n            if (data) {\n                if (response < 300) {\n                    result = JSON.parse(data);\n                }\n                else {\n                    result = data;\n                }\n            }\n\n            if (typeof callback != 'undefined') {\n                callback({\n                    response: response,\n                    body: result\n                });\n            }\n        });\n    });\n\n    if (body) {\n        req.write(json_body);\n    }\n    req.end();\n}\n\nTempoDBClient.prototype.create_series = function(key, callback) {\n    data = {};\n\n    if (typeof key == 'string' && key) {\n        data.key = key;\n    }\n\n    return this.call('POST', '/series/', data, callback);\n}\n\nTempoDBClient.prototype.get_series = function(options, callback) {\n    /*\n        options\n            id (Array of ids or single id)\n            key (Array of keys or single key)\n            tag (string or Array[string])\n            attr ({key: val, key2: val2})\n\n    */\n    options = options || {};\n    query_string = '?' + EncodeQueryData(options);\n\n    return this.call('GET', '/series/' + query_string, null, callback);\n}\n\nTempoDBClient.prototype.update_series = function(series_id, series_key, name, attributes, tags, callback) {\n    if (!(tags instanceof Array)) {\n        throw ID + 'tags must be an array';\n    }\n\n    if (!(attributes instanceof Object)) {\n        throw ID + 'attributes must be an Object';\n    }\n\n    data = {\n        id: series_id,\n        key: series_key,\n        name: name,\n        attributes: attributes,\n        tags: tags\n    }\n\n    return this.call('PUT', '/series/id/' + series_id + '/', data, callback);\n}\n\nTempoDBClient.prototype.read = function(start, end, options, callback) {\n    /*\n        options\n            id (Array of ids or single id)\n            key (Array of keys or single key)\n            interval (string)\n            function (string)\n\n    */\n    options = options || {};\n    options.start = ISODateString(start);\n    options.end = ISODateString(end);\n    query_string = '?' + EncodeQueryData(options);\n\n    return this.call('GET', '/data/' + query_string, null, callback);\n};\n\nTempoDBClient.prototype.read_id = function(series_id, start, end, options, callback) {\n    /*\n        options\n            interval (string)\n            function (string)\n\n    */\n    options = options || {};\n    options.start = ISODateString(start);\n    options.end = ISODateString(end);\n    query_string = '?' + EncodeQueryData(options);\n\n    return this.call('GET', '/series/id/' + series_id + '/data/' + query_string, null, callback);\n}\n\nTempoDBClient.prototype.read_key = function(series_key, start, end, options, callback) {\n    /*\n        options\n            interval (string)\n            function (string)\n\n    */\n    options = options || {};\n    options.start = ISODateString(start);\n    options.end = ISODateString(end);\n    query_string = '?' + EncodeQueryData(options);\n\n    return this.call('GET', '/series/key/' + series_key + '/data/' + query_string, null, callback);\n}\n\nTempoDBClient.prototype.write_id = function(series_id, data, callback) {\n    return this.call('POST', '/series/id/' + series_id + '/data/', data, callback);\n}\n\nTempoDBClient.prototype.write_key = function(series_key, data, callback) {\n    return this.call('POST', '/series/key/' + series_key + '/data/', data, callback);\n}\n\nTempoDBClient.prototype.write_bulk = function(ts, data, callback) {\n    var body = {\n        t: ISODateString(ts),\n        data: data\n    }\n\n    return this.call('POST', '/data/', body, callback);\n}\n\nTempoDBClient.prototype.increment_id = function(series_id, data, callback) {\n    return this.call('POST', '/series/id/' + series_id + '/increment/', data, callback);\n}\n\nTempoDBClient.prototype.increment_key = function(series_key, data, callback) {\n    return this.call('POST', '/series/key/' + series_key + '/increment/', data, callback);\n}\n\nTempoDBClient.prototype.increment_bulk = function(ts, data, callback) {\n    var body = {\n        t: ISODateString(ts),\n        data: data\n    }\n\n    return this.call('POST', '/increment/', body, callback);\n}\n\nTempoDBClient.prototype.delete_id = function(series_id, start, end, callback) {\n  var options = {\n    start: ISODateString(start),\n    end:   ISODateString(end)\n  }\n  var query_string = '?' + EncodeQueryData(options);\n\n  return this.call('DELETE', '/series/id/'+series_id+'/data/'+query_string, null, callback);\n}\n\nTempoDBClient.prototype.delete_key = function(series_key, start, end, callback) {\n  var options = {\n    start: ISODateString(start),\n    end:   ISODateString(end)\n  }\n\n  var query_string = '?' + EncodeQueryData(options);\n\n  return this.call('DELETE', '/series/key/'+series_key+'/data/'+query_string, null, callback);\n}\n\n\nvar EncodeQueryData = function(data) {\n   var ret = [];\n   for (var key in data) {\n        var value = data[key];\n\n        if (value instanceof Array) {\n            for (var v in value){\n                ret.push(encodeURIComponent(key) + \"=\" + encodeURIComponent(value[v]));\n            }\n        }\n        else if (value instanceof Object) {\n            for (var v in value){\n                ret.push(encodeURIComponent(key) + \"[\" + encodeURIComponent(v) + \"]=\" + encodeURIComponent(value[v]));\n            }\n        }\n        else {\n            // plain value\n            ret.push(encodeURIComponent(key) + \"=\" + encodeURIComponent(value));\n        }\n    }\n\n   return ret.join(\"&\");\n}\n\nvar ISODateString = function(d) {\n    // If you pass a string for a date we will assume that it is already in ISO format\n    if(typeof(d) == 'string') {\n        return d;\n    }\n\n    function pad(n) {\n        return n<10 ? '0' + n : n;\n    }\n\n    return d.getUTCFullYear() + '-' +\n        pad(d.getUTCMonth() + 1) + '-' +\n        pad(d.getUTCDate()) + 'T' +\n        pad(d.getUTCHours()) + ':' +\n        pad(d.getUTCMinutes()) + ':' +\n        pad(d.getUTCSeconds()) + 'Z';\n};\n"]],"start1":0,"start2":0,"length1":0,"length2":8047}]],"length":8047}
