{"ts":1380272020329,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var https = require('https');\nvar yacsv = require('ya-csv');\nvar fs = require('fs');\nvar mongodb = require('./mongodb');\nvar iconv = require('iconv-lite');\n\nvar wineListRequestUrl = 'https://www.cellartracker.com/xlquery.asp?table=List&Format=csv&Location=1&User=lagnak&Password=satanas';\nvar csvfilename = '/tmp/cellartracker.csv';\n\nvar TYPE={red: 'rouge', white: 'blanc',  };\n\nfunction readCsv() {\n\tconsole.log('--------readCsv...');\n\tvar reader = yacsv.createCsvFileReader(csvfilename, {\n\t\t\t'separator': ',',\n\t\t\t'quote': '\"',\n\t\t\t'escape': '',\n\t\t\t'comment': '',\n\t\t\t'encoding': 'utf-8',\n\t\t\t'columnsFromHeader': true\n\t\t});\n\t\t//reader.setColumnNames([ 'iWine','WineBarcode','Quantity','Pending','Location','Bin','Size','Price','Valuation','MyValue','WBValue','CTValue','MenuPrice', 'Vintage',\n\t\t//\t\t\t\t\t\t'Wine','Locale','Country','Region','SubRegion','Appellation','Producer','SortProducer','Type','Varietal','MasterVarietal','Designation',\n\t\t//\t\t\t\t\t\t'Vineyard','WA','WS','IWC','BH','WE','JR','RH','JG','GV','JK','LD','CW','WFW','PR','SJ','WD','RR','JH','MFW','WWR','IWR','CHG','TT','CT','MY','BeginConsume','EndConsume','UPC' ]);\n\t\t//Insertion des data\n\t\treader.addListener('data', function(data) {\n\t\t\t//console.log(data);\n\t\t\tif(data.CT == '\"') { data.CT = 0;} else { data.CT = parseInt(data.CT)};\n\t\t\tif(data.Price == '\"') { data.Price = 0;} else { data.Price = parseInt(data.Price)};\n\t\t\tif(data.Designation=='Unknown') { data.Designation='';}\n\t\t\tif(data.Vineyard=='Unknown') { data.Vineyard='';}\n\t\t\tif(data.SubRegion=='Unknown') { data.SubRegion='';}\n\t\t\tif(data.Bin=='\"') { data.Bin='';}\n\n\t\t\t//TODO data.Type=transcode ?\n\t\t\t//saveCellarTrackerData(data);\n\t\t\tmongodb.saveWine(data);\n\n\t\t});\n\n}\n\nfunction saveCellarTrackerData(data) {\n\t//console.log('--------saveCellarTrackerData...');\n\tmongodb.saveWine(data);\n}\n\nfunction getCellarTrackerData() {\n\tconsole.log('--------getCellarTrackerData...');\n\n\tvar csvfile = fs.createWriteStream(csvfilename, {flags: 'w'});\n\n\thttps.get(wineListRequestUrl, function(res) {\n\t\t//console.log(\"statusCode: \", res.statusCode);\n\t\t//console.log(\"headers: \", res.headers);\n\t\tres.on('data', function(d) {\n\t\t\tcsvfile.write(iconv.decode(new Buffer(d), 'latin1')); // decoding des chracteres latin1\n\t\t}).on('end', function () {\n\t\t\tcsvfile.end();\n\t\t\tconsole.log('file created !');\n\t\t\treadCsv();\n\t\t});\n\t}).on('error', function(e) {\n\t\tconsole.error(e);\n\t});\n\n}\n\nmodule.exports.getCellarTrackerData=getCellarTrackerData;\n\n\n//getCellarTrackerData();\n//mongodb.getWinesByCountry();\n//mongodb.getWinesByType();\n//mongodb.getWinesByVintage();\n\n"]],"start1":0,"start2":0,"length1":0,"length2":2559}]],"length":2559}
{"contributors":[],"silentsave":true,"ts":1380272035338,"patch":[[{"diffs":[[0,"/mongodb"],[1,".r"],[0,"');\nvar "]],"start1":109,"start2":109,"length1":16,"length2":18}]],"length":2561,"saved":false}
{"ts":1380272037532,"patch":[[{"diffs":[[0,"ongodb.r"],[1,"efacto"],[0,"');\nvar "]],"start1":111,"start2":111,"length1":16,"length2":22}]],"length":2567,"saved":false}
{"contributors":[],"silentsave":true,"ts":1380275277836,"patch":[[{"diffs":[[0,"godb"],[-1,".refacto"],[0,"');\n"]],"start1":113,"start2":113,"length1":16,"length2":8}]],"length":2559,"saved":false}
{"ts":1380275509161,"patch":[[{"diffs":[[0,"ongodb')"],[1,"(mongoose)"],[0,";\nvar ic"]],"start1":111,"start2":111,"length1":16,"length2":26}]],"length":2569,"saved":false}
{"ts":1380275586268,"patch":[[{"diffs":[[0,"db')"],[-1,"(mongoose)"],[0,";\nva"]],"start1":115,"start2":115,"length1":18,"length2":8}]],"length":2559,"saved":false}
